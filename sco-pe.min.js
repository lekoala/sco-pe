var c={debug:!1,loadDelay:300,activeClass:"active",reloadHeader:"X-Reload",titleHeader:"X-Title",cssHeader:"x-include-css",jsHeader:"x-include-js",confirmHandler:s=>new Promise((t,e)=>{confirm(s)?t():e()}),statusHeader:"X-Status",statusHandler:(s,t)=>{alert(s)},onLoad:s=>{},onScopeLoad:s=>{}},y=null,m=[],A=!0,L=[],H=!1,E;function _(s){return s instanceof HTMLFormElement?["submit"]:(s.dataset.scopeOn||"click").split(",")}function x(s){return s.getAttribute("action")||s.dataset.scopeAction||s.getAttribute("href")}function $(s){let t=x(s);return!t||Q(s)||N(t)||q(t)}function D(s,t=300){let e;return(...i)=>{e&&clearTimeout(e),e=setTimeout(()=>{s.apply(this,i)},t)}}function M(s){return["1","true",!0,1].includes(s)}function F(s,t=null){let e="true";return s.dataset.scopeHistory?e=s.dataset.scopeHistory:t&&t.dataset.scopeHistory&&(e=t.dataset.scopeHistory),M(e)}function j(s){return new DOMParser().parseFromString(s,"text/html")}function P(s){let t=document.createElement("template");return t.innerHTML=s,t.content}function B(s){let t=document.createElement("div");return t.appendChild(s),t.innerHTML}function w(s){return s.textContent.trim()===""&&!s.firstElementChild}function f(s){let t=s?s.toString():"#";return new URL(t,document.baseURI)}function v(s){return f(s).href.split("#")[0]}function N(s){return s?f(s).origin!==location.origin:!1}function Q(s){return s.getAttribute("target")==="_blank"}function V(s){if(!s)return null;let t;return s.hash?s.hash.slice(1):(t=s.href.match(/#(.*)$/))?t[1]:null}function q(s){return V(f(s))!==null}function T(s){let t=0;for(let e=0;e<s.length;e++){let i=s.charCodeAt(e);t=(t<<5)-t+i,t&=t}return new Uint32Array([t])[0].toString(36)}function R(s){return s===null?null:s.scrollHeight>s.clientHeight?s:R(s.parentElement)}function z(s){let t=R(s);t?t.scrollTop=0:s.scrollIntoView(!0)}function o(s){c.debug&&console.log(`[sco-pe] ${s}`)}function G(s,t){let e=new RegExp(`<[a-z]+-[a-z]+.*>.*</[a-z]+-[a-z]+>|${c.activeClass}|\\s+|style=".*?"`,"gmi"),i=s.innerHTML.replace(e,"").trim(),n=t.innerHTML.replace(e,"").trim();return i!=n}function O(s,t){let e=s.querySelectorAll("[data-scope-fragment]");if(!e.length){o(`Replacing ${s.id} content`),s.innerHTML=t.innerHTML;return}e.forEach(i=>{let n=i.id?`#${i.id}`:`.${i.classList.item(0)}`,a=t.querySelector(n);if(a){let r=i.dataset.scopeFragment;(r.length>0?r!=a.dataset.scopeFragment:!i.isEqualNode(a))&&(o(`Replacing ${n} fragment`),i.innerHTML=a.innerHTML)}else i.dataset.scopedFixed||i.remove()})}window.addEventListener("popstate",async s=>{if(s.state){let t=s.state.scope||null;if(t){let e=t.id,i=t.url,n=document.querySelector(`sco-pe[id="${e}"]`);if(n){o("Restore location from history"),await n.loadURL(i,{},t.hint);return}}}s.state===null&&window.location.replace(document.location.toString())});var k=class extends HTMLElement{constructor(){super();this.abortController=null,this.init=!1,this.events=["click","submit"],this.loadFunc=D((t,e)=>{this.load(t,e)},c.loadDelay)}static configure(t){c=Object.assign(c,t)}handleEvent(t){if(t.target.closest("sco-pe")!==this||M(this.dataset.scopeDisabled))return;let e=t.target.closest("a,button,[data-scope-action]");if(t.type==="submit"&&(e=t.target),e){if(!_(e).includes(t.type)||$(e))return;o(`Handling ${t.type} on ${e.nodeName}`),t.preventDefault();let n=["input","scroll","resize","mousemove","touchmove","keyup","keydown"],a=()=>{n.includes(t.type)?this.loadFunc(e,t):this.load(e,t)};e.dataset.scopeConfirm?c.confirmHandler(e.dataset.scopeConfirm).then(a).catch(r=>null):a()}}abortLoading(){this.abortController&&this.abortController.abort()}async load(t,e){let i=x(t),n=f(i).href,a=n,r=t.nodeName==="A",d=e.submitter||null,l=t.dataset.scopeHint,u=(t.getAttribute("method")||t.dataset.scopeMethod||"GET").toUpperCase(),p=r&&F(t,this)&&this.hasAttribute("id"),h;d&&d.setAttribute("disabled","");let b=new URLSearchParams(window.location.search),C=t.value!=="undefined"?t.value:t.dataset.scopeValue;if(typeof C<"u"&&(b.set("value",C),a=`${n}?${b.toString()}`,h=b),t instanceof HTMLFormElement){let S=new FormData(t);d&&S.append(d.name,d.value||"true"),this._hash=S.get("_hash"),h=S}let g=t.dataset.scopeTarget||this.dataset.scopeTarget;if(g&&g!=="_self"){o(`Loading into targeted scope ${g}`),document.getElementById(g).setAttribute("src",a);return}p&&this.updateHistory(n,l),r&&(this.removeActiveClass(),this.setActive(t)),u==="GET"&&(n=a);let U=u==="POST"?h:null;await this.loadURL(n,{method:u,body:U},l),d&&d.removeAttribute("disabled")}updateHistory(t,e){if(history.state){let a=history.state.scope&&history.state.scope.url;if(v(a)==v(t))return}let n={id:this.getAttribute("id"),url:t,hint:e};history.pushState({scope:n},null,t)}setActive(t){o("Set active element"),t.classList.add(c.activeClass)}removeActiveClass(){this.querySelectorAll(`.${c.activeClass}`).forEach(t=>{$(t)||(t===document.activeElement&&t.blur(),t.classList.remove(c.activeClass))})}async loadURL(t,e={},i=null){e.signal||(o(`GET ${t}`),y&&y.abort(),y=new AbortController,e.signal=y.signal);let n=Object.assign({method:"GET"},e),a=i?document.getElementById(i):this;a.classList.add("scope-fetching");try{let r=await fetch(t,n);if(r.redirected){let l=r.url;this._hash&&(l+=this._hash),this.updateHistory(l,i)}if(!r.ok){let l=r.headers.get(c.statusHeader)||r.statusText;c.statusHandler(l,r.status);return}this._processHeaders(r);let d=await r.text();this._processResponse(d)}catch(r){r.name==="AbortError"||c.statusHandler(r.message)}a.classList.remove("scope-fetching")}_processHeaders(t){if(c.statusHeader){let e=t.headers.get(c.statusHeader);e&&c.statusHandler(e,t.status)}if(c.titleHeader){let e=t.headers.get(c.titleHeader);e&&(document.title=e)}if(c.reloadHeader&&t.headers.get(c.reloadHeader)&&window.location.reload(),c.jsHeader){let e=t.headers.get(c.jsHeader);e&&e.split(",").forEach(i=>{this._loadScript(i)})}if(c.cssHeader){let e=t.headers.get(c.cssHeader);e&&e.split(",").forEach(i=>{this._loadStyle(i)})}}_processHead(t){o("Process head");let e=t.querySelector("title");e&&(document.title=e.textContent)}_processBody(t){document.body.style.cssText=t.style.cssText,["class"].forEach(i=>{document.body.setAttribute(i,t.getAttribute(i)||"")})}_processDocument(t){["class"].forEach(i=>{document.documentElement.setAttribute(i,t.documentElement.getAttribute(i)||"")});for(let i in t.documentElement.dataset)document.documentElement.dataset[i]=t.documentElement.dataset[i]}_loadScript(t,e="text/javascript"){return document.querySelector(`script[src="${t}"]`)?!1:(o(`Loading script ${t}`),L.push({type:e,src:t}),!0)}_processScriptsQueue(){A=L.length===0;let t=L.shift();if(A){H&&this._processInlineScriptsQueue(),o("All scripts loaded");return}let e=document.createElement("script");e.setAttribute("type",t.type),e.setAttribute("src",t.src),e.onload=e.onerror=i=>{o(`Loaded script ${t.src}`),this._processScriptsQueue()},document.head.appendChild(e)}_loadInlineScript(t){let e=T(t.innerHTML),i=t.type||"text/javascript",n=t.getAttribute("id")||`script-${e}`;if(document.querySelector(`script[id="${n}"]`)&&t.getAttribute("id"))return;let r=t.innerHTML;m.push({content:r,type:i,id:n})}_processInlineScriptsQueue(){o(`Executing ${m.length} inline scripts`),m.forEach(t=>{o("Executing inline script");let e=document.createElement("script");e.setAttribute("type",t.type),e.setAttribute("id",t.id),e.innerHTML=t.content;let i=document.querySelector(`script[id="${t.id}"]`);i?i.replaceWith(e):document.head.appendChild(e)}),m=[],o("Calling global onload"),c.onLoad(this)}_loadStyle(t){if(document.querySelector(`link[href="${t}"]`))return;o(`Loading style ${t}`);let i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("href",t),document.head.appendChild(i)}_processScriptsAndStyles(t){document.querySelectorAll("script:not([src]):not([id]),style:not([id])").forEach(i=>{let n=T(i.innerHTML),a=`${i.nodeName.toLowerCase()}-${n}`;i.setAttribute("id",a)});let e=!0;t.querySelectorAll("script").forEach(i=>{i.hasAttribute("src")?this._loadScript(i.getAttribute("src"),i.type)&&(e=!1):this._loadInlineScript(i),i.remove()}),e||this._processScriptsQueue(),o(`${m.length} pending inline scripts ${e?"(can trigger immediately)":""}`),t.querySelectorAll('style,link[rel="stylesheet"]').forEach(i=>{let n=i.getAttribute("href");if(n)this._loadStyle(n);else{let a=T(i.innerHTML),r=i.getAttribute("id")||`style-${a}`;if(document.querySelector(`style[id="${r}"]`))return;o("Loading inline style");let l=document.createElement("style");l.innerHTML=i.innerHTML,l.setAttribute("id",r),document.head.appendChild(l)}})}_processResponse(t){let e=t.match(/<!doctype\s+html[\s>]/i),i=t.indexOf("<sco-pe")!==-1,n=e?j(t):P(t);if(this._processScriptsAndStyles(n),e||i){o(`Loading scopes ${e?"(full)":"(partial)"}`);let a=n.querySelector("head");a&&this._processHead(a);let r=n.querySelector("body");r&&this._processBody(r),e&&n instanceof Document&&this._processDocument(n);let d=n.querySelectorAll("sco-pe");d.length||(document.body.innerHTML=t,this._checkScopesAreLoaded()),d.forEach(l=>{let u=l.getAttribute("id");if(!u){o("Scope without id");return}let p=l.getAttribute("src");if(w(l)&&!p){o(`Empty scope for ${u}`);return}let h=document.getElementById(u);if(!h){o(`No matching scope for ${u}`);return}if(p&&f(p).toString()===f(h.src).toString()){o(`Url has not changed for ${u}`);return}p&&p!=h.src?(o(`Replacing ${u} src`),h.src=p):G(h,l)&&(O(h,l),this._afterLoad())}),document.scrollingElement.scrollTo(0,0)}else o(`Loading partial document into self (${this.id})`),this.innerHTML=B(n),this._afterLoad(),z(this)}async loadContent(t=!1){let e=this.src,i=t&&!w(this);e&&!i?(this.classList.remove("scope-loaded"),this.abortLoading(),this.abortController=new AbortController,await this.loadURL(e,{signal:this.abortController.signal})):this._afterLoad()}_afterLoad(){this._listenToEvents(),this.removeActiveClass();let t=v(document.location.href).replace(/\/$/,"");this.querySelectorAll("a").forEach(e=>{let i=e.getAttribute("href"),n=f(i);q(n)||n.toString().replace(/\/$/,"")==t&&this.setActive(e)}),this.classList.remove("scope-fetching"),this.classList.add("scope-loaded"),this.dispatchEvent(new CustomEvent("scope-loaded")),c.onScopeLoad(this),this._checkScopesAreLoaded()}_checkScopesAreLoaded(){E&&clearTimeout(E),E=setTimeout(()=>{H=document.querySelectorAll("sco-pe:not(.scope-loaded)").length===0,H&&A&&(this._processInlineScriptsQueue(),o("All scripts loaded (no scripts to load)"))})}_listenToEvents(){this.querySelectorAll("[data-scope-on]").forEach(t=>{this.events=this.events.concat(_(t))}),this.events.forEach(t=>{this.addEventListener(t,this)})}static get observedAttributes(){return["src"]}set src(t){this.setAttribute("src",t)}get src(){return this.getAttribute("src")}attributeChangedCallback(t,e,i){if(!!this.init)switch(t){case"src":this.loadContent();break}}connectedCallback(){setTimeout(async()=>{o(`Scope init ${this.id||"(no id)"}`),await this.loadContent(!0),this.init=!0,o(`Scope created ${this.id||"(no id)"}`)})}disconnectedCallback(){this.events.forEach(t=>{this.removeEventListener(t,this)}),o(`Scope destroyed ${this.id||"(no id)"}`)}},I=k;customElements.define("sco-pe",I);
//# sourceMappingURL=sco-pe.min.js.map
