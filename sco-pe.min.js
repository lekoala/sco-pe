var o={debug:!1,loadDelay:300,activeClass:"active",fakeLocationHeader:"X-Location",reloadHeader:"X-Reload",titleHeader:"X-Title",cssHeader:"X-Include-CSS",jsHeader:"X-include-JS",confirmHandler:s=>new Promise((t,e)=>{confirm(s)?t():e()}),statusHeader:"X-Status",statusHandler:(s,t)=>{alert(s)},progressHandler:(s,t)=>{},onLoad:s=>{},onScopeLoad:s=>{}},b=null,g=[],A=!0,H=[],E=!1,v;function $(s){return s instanceof HTMLFormElement?["submit"]:(s.dataset.scopeOn||"click").split(",")}function R(s){return s.getAttribute("action")||s.dataset.scopeAction||s.getAttribute("href")}function w(s){let t=R(s);return!t||V(s)||Q(t)||q(t)}function P(s,t=300){let e;return(...i)=>{e&&clearTimeout(e),e=setTimeout(()=>{s.apply(this,i)},t)}}function M(s){return["1","true",!0,1].includes(s)}function j(s,t=null){let e="true";return s.dataset.scopeHistory?e=s.dataset.scopeHistory:t&&t.dataset.scopeHistory&&(e=t.dataset.scopeHistory),M(e)}function N(s){return new DOMParser().parseFromString(s,"text/html")}function X(s){let t=document.createElement("template");return t.innerHTML=s,t.content}function B(s){let t=document.createElement("div");return t.appendChild(s),t.innerHTML}function x(s){return s.textContent.trim()===""&&!s.firstElementChild}function p(s){let t=s?s.toString():"#";return new URL(t,document.baseURI)}function T(s){return p(s).href.split("#")[0]}function Q(s){return s?p(s).origin!==location.origin:!1}function V(s){return s.getAttribute("target")==="_blank"}function z(s){if(!s)return null;let t;return s.hash?s.hash.slice(1):(t=s.href.match(/#(.*)$/))?t[1]:null}function q(s){return z(p(s))!==null}function C(s){let t=0;for(let e=0;e<s.length;e++){let i=s.charCodeAt(e);t=(t<<5)-t+i,t&=t}return new Uint32Array([t])[0].toString(36)}function I(s){return s===null?null:s.scrollHeight>s.clientHeight?s:I(s.parentElement)}function G(s){let t=I(s);t?t.scrollTop=0:s.scrollIntoView(!0)}function c(s){o.debug&&console.log(`[sco-pe] ${s}`)}function O(s,t){let e=new RegExp(`<[a-z]+-[a-z]+.*>.*</[a-z]+-[a-z]+>|${o.activeClass}|\\s+|style=".*?"`,"gmi"),i=s.innerHTML.replace(e,"").trim(),n=t.innerHTML.replace(e,"").trim();return i!=n}function W(s,t){let e=s.querySelectorAll("[data-scope-fragment]");if(!e.length){c(`Replacing ${s.id} content`),s.innerHTML=t.innerHTML;return}e.forEach(i=>{let n=i.id?`#${i.id}`:`.${i.classList.item(0)}`,r=t.querySelector(n);if(r){let l=i.dataset.scopeFragment;(l.length>0?l!=r.dataset.scopeFragment:!i.isEqualNode(r))&&(c(`Replacing ${n} fragment`),i.innerHTML=r.innerHTML)}else i.dataset.scopedFixed||i.remove()})}function J(s,t){return t=t||{},t.headers=t.headers||{},t.headers["X-Requested-With"]="XMLHttpRequest",t.referrerPolicy||(t.referrerPolicy="no-referrer-when-downgrade"),fetch(s,t)}function k(s){return decodeURI(s.replace(/\+/g," "))}window.addEventListener("popstate",async s=>{let t=!1;if(s.state){let e=s.state.scope||null;if(e){let i=e.id,n=e.url,r=document.querySelector(`sco-pe[id="${i}"]`);if(r){c("Restore location from history"),await r.loadURL(n,{},e.hint);return}else t=!0}}(s.state===null||t)&&window.location.replace(document.location.toString())});var U=class extends HTMLElement{constructor(){super();this.abortController=null,this.init=!1,this.events=["click","submit"],this.loadFunc=P((t,e)=>{this.load(t,e)},o.loadDelay)}static configure(t){o=Object.assign(o,t)}handleEvent(t){if(t.target.closest("sco-pe")!==this||M(this.dataset.scopeDisabled))return;let e=t.target.closest("a,button,[data-scope-action]");if(t.type==="submit"&&(e=t.target),e){if(!$(e).includes(t.type)||w(e))return;c(`Handling ${t.type} on ${e.nodeName}`),t.preventDefault();let n=["input","scroll","resize","mousemove","touchmove","keyup","keydown"],r=()=>{n.includes(t.type)?this.loadFunc(e,t):this.load(e,t)};e.dataset.scopeConfirm?o.confirmHandler(e.dataset.scopeConfirm).then(r).catch(l=>null):r()}}abortLoading(){this.abortController&&this.abortController.abort()}async load(t,e){let i=R(t),n=p(i).href,r=n,l=t.nodeName==="A"||t.dataset.scopeLink,a=e.submitter||null,d=t.dataset.scopeHint||this.dataset.scopeHint,u=(t.getAttribute("method")||t.dataset.scopeMethod||"GET").toUpperCase(),f=l&&j(t,this)&&this.hasAttribute("id"),h;a&&a.setAttribute("disabled","");let S=new URLSearchParams(window.location.search),_=t.value!=="undefined"?t.value:t.dataset.scopeValue;if(typeof _<"u"&&(S.set("value",_),r=`${n}?${S.toString()}`,h=S),t instanceof HTMLFormElement){let m=new FormData(t);a&&m.append(a.name,a.value||"true"),this._hash=m.get("_hash"),h=m}let y=t.dataset.scopeTarget||this.dataset.scopeTarget;if(y&&y!=="_self"){c(`Loading into targeted scope ${y}`),document.getElementById(y).setAttribute("src",r);return}u==="GET"&&(n=r);let D=u==="POST"?h:null;o.progressHandler(this,"start");let L=await this.loadURL(n,{method:u,body:D},d);if(f&&!L.error){let m=L.redirected||n;this.updateHistory(m,d)}l&&(this.removeActiveClass(),this.setActive(t),this._markActive()),a&&a.removeAttribute("disabled"),L.aborted||o.progressHandler(this,"done")}updateHistory(t,e){if(history.state){let r=history.state.scope&&history.state.scope.url;if(T(r)==T(t))return}let n={id:this.getAttribute("id"),url:t,hint:e};history.pushState({scope:n},null,t)}setActive(t){c("Set active element"),t.classList.add(o.activeClass)}removeActiveClass(){this.querySelectorAll(`.${o.activeClass}`).forEach(t=>{w(t)||(t===document.activeElement&&t.blur(),t.classList.remove(o.activeClass))})}async loadURL(t,e={},i=null){e.signal||(c(`GET ${t}`),b&&b.abort(),b=new AbortController,e.signal=b.signal);let n=Object.assign({method:"GET"},e);try{let r=await J(t,n);if(!r.ok){let a=r.headers.get(o.statusHeader)||r.statusText;return o.statusHandler(a,r.status),{error:a}}if(this._processHeaders(r),o.fakeLocationHeader){let a=r.headers.get(o.fakeLocationHeader);if(a)return await this.loadURL(a),{redirected:a}}let l=await r.text();if(this._processResponse(l),r.redirected)return{redirected:r.url}}catch(r){return r.name==="AbortError"||o.statusHandler(r.message),{error:r.message,aborted:r.name==="AbortError"}}return{}}_processHeaders(t){if(o.statusHeader){let e=t.headers.get(o.statusHeader);e&&o.statusHandler(k(e),t.status)}if(o.titleHeader){let e=t.headers.get(o.titleHeader);e&&(document.title=k(e))}if(o.reloadHeader&&t.headers.get(o.reloadHeader)&&window.location.reload(),o.jsHeader){let e=t.headers.get(o.jsHeader);e&&e.split(",").forEach(i=>{this._loadScript(i)})}if(o.cssHeader){let e=t.headers.get(o.cssHeader);e&&e.split(",").forEach(i=>{this._loadStyle(i)})}}_processHead(t){c("Process head");let e=t.querySelector("title");e&&(document.title=e.textContent)}_processBody(t){document.body.style.cssText=t.style.cssText,["class"].forEach(i=>{document.body.setAttribute(i,t.getAttribute(i)||"")})}_processDocument(t){["class"].forEach(i=>{document.documentElement.setAttribute(i,t.documentElement.getAttribute(i)||"")});for(let i in t.documentElement.dataset)document.documentElement.dataset[i]=t.documentElement.dataset[i]}_loadScript(t,e="text/javascript"){return document.querySelector(`script[src="${t}"]`)?!1:(c(`Loading script ${t}`),H.push({type:e,src:t}),!0)}_processScriptsQueue(){A=H.length===0;let t=H.shift();if(A){E&&this._processInlineScriptsQueue(),c("All scripts loaded");return}let e=document.createElement("script");e.setAttribute("type",t.type),e.setAttribute("src",t.src),e.onload=e.onerror=i=>{c(`Loaded script ${t.src}`),this._processScriptsQueue()},document.head.appendChild(e)}_loadInlineScript(t){let e=C(t.innerHTML),i=t.type||"text/javascript",n=t.getAttribute("id")||`script-${e}`;if(document.querySelector(`script[id="${n}"]`)&&t.getAttribute("id"))return;let l=t.innerHTML;g.push({content:l,type:i,id:n})}_processInlineScriptsQueue(){c(`Executing ${g.length} inline scripts`),g.forEach(t=>{c("Executing inline script");let e=document.createElement("script");e.setAttribute("type",t.type),e.setAttribute("id",t.id),e.innerHTML=t.content;let i=document.querySelector(`script[id="${t.id}"]`);i?i.replaceWith(e):document.head.appendChild(e)}),g=[],c("Calling global onload"),o.onLoad(this)}_loadStyle(t){if(document.querySelector(`link[href="${t}"]`))return;c(`Loading style ${t}`);let i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("href",t),document.head.appendChild(i)}_processScriptsAndStyles(t){document.querySelectorAll("script:not([src]):not([id]),style:not([id])").forEach(i=>{let n=C(i.innerHTML),r=`${i.nodeName.toLowerCase()}-${n}`;i.setAttribute("id",r)});let e=!0;t.querySelectorAll("script").forEach(i=>{i.hasAttribute("src")?this._loadScript(i.getAttribute("src"),i.type)&&(e=!1):this._loadInlineScript(i),i.remove()}),e||this._processScriptsQueue(),c(`${g.length} pending inline scripts ${e?"(can trigger immediately)":""}`),t.querySelectorAll('style,link[rel="stylesheet"]').forEach(i=>{let n=i.getAttribute("href");if(n)this._loadStyle(n);else{let r=C(i.innerHTML),l=i.getAttribute("id")||`style-${r}`;if(document.querySelector(`style[id="${l}"]`))return;c("Loading inline style");let d=document.createElement("style");d.innerHTML=i.innerHTML,d.setAttribute("id",l),document.head.appendChild(d)}})}_processResponse(t){let e=t.match(/<!doctype\s+html[\s>]/i),i=t.indexOf("<sco-pe")!==-1,n=e?N(t):X(t);if(this._processScriptsAndStyles(n),e||i){c(`Loading scopes ${e?"(full)":"(partial)"}`);let r=n.querySelector("head");r&&this._processHead(r);let l=n.querySelector("body");l&&this._processBody(l),e&&n instanceof Document&&this._processDocument(n);let a=n.querySelectorAll("sco-pe");a.length||(document.body.innerHTML=t,this._checkScopesAreLoaded()),a.forEach(d=>{let u=d.getAttribute("id");if(!u){c("Scope without id");return}let f=d.getAttribute("src");if(x(d)&&!f){c(`Empty scope for ${u}`);return}let h=document.getElementById(u);if(!h){c(`No matching scope for ${u}`);return}if(f&&p(f).toString()===p(h.src).toString()){c(`Url has not changed for ${u}`);return}f&&f!=h.src?(c(`Replacing ${u} src`),h.src=f):O(h,d)&&(W(h,d),this._afterLoad())}),document.scrollingElement.scrollTo(0,0)}else c(`Loading partial document into self (${this.id})`),this.innerHTML=B(n),this._afterLoad(),G(this)}async loadContent(t=!1){let e="scope-fetching";if(this.classList.contains(e))return;let i=this.src,n=t&&!x(this);i&&!n?(this.classList.remove("scope-loaded"),this.abortLoading(),this.abortController=new AbortController,this.classList.add(e),await this.loadURL(i,{signal:this.abortController.signal}),this.classList.remove(e)):this._afterLoad(),this._markActive()}_markActive(){let t=!1,e=T(document.location.href).replace(/\/$/,"");this.querySelectorAll("a").forEach(i=>{let n=i.getAttribute("href"),r=p(n);q(r)||r.toString().replace(/\/$/,"")==e&&(t||(this.removeActiveClass(),t=!0),this.setActive(i))})}_afterLoad(){this._listenToEvents(),this.classList.add("scope-loaded"),this.dispatchEvent(new CustomEvent("scope-loaded")),o.onScopeLoad(this),this._checkScopesAreLoaded()}_checkScopesAreLoaded(){v&&clearTimeout(v),v=setTimeout(()=>{E=document.querySelectorAll("sco-pe:not(.scope-loaded)").length===0,E&&A&&(this._processInlineScriptsQueue(),c("All scripts loaded (no scripts to load)"))})}_listenToEvents(){this.querySelectorAll("[data-scope-on]").forEach(t=>{this.events=this.events.concat($(t))}),this.events.forEach(t=>{this.addEventListener(t,this)})}static get observedAttributes(){return["src"]}set src(t){this.setAttribute("src",t)}get src(){return this.getAttribute("src")}attributeChangedCallback(t,e,i){if(!!this.init)switch(t){case"src":this.loadContent();break}}connectedCallback(){setTimeout(async()=>{c(`Scope init ${this.id||"(no id)"}`),await this.loadContent(!0),this.init=!0,c(`Scope created ${this.id||"(no id)"}`)})}disconnectedCallback(){this.events.forEach(t=>{this.removeEventListener(t,this)}),c(`Scope destroyed ${this.id||"(no id)"}`)}},F=U;customElements.define("sco-pe",F);
//# sourceMappingURL=sco-pe.min.js.map
