var o={debug:!1,debounceTime:300,activeClass:"active",reloadHeader:"X-Reload",titleHeader:"X-Title",cssHeader:"x-include-css",jsHeader:"x-include-js",confirmHandler:s=>new Promise((t,e)=>{confirm(s)?t():e()}),statusHeader:"X-Status",statusHandler:(s,t)=>{alert(s)},onLoad:s=>{}},f=null;function y(s){return s instanceof HTMLFormElement?["submit"]:(s.dataset.scopeOn||"click").split(",")}function L(s){return s.getAttribute("action")||s.dataset.scopeAction||s.getAttribute("href")}function w(s,t=300){let e;return(...i)=>{clearTimeout(e),e=setTimeout(()=>{s.apply(this,i)},t)}}function H(s){return["1","true",!0,1].includes(s)}function v(s,t=null){let e="true";return s.dataset.scopeHistory?e=s.dataset.scopeHistory:t&&t.dataset.scopeHistory&&(e=t.dataset.scopeHistory),H(e)}function $(s){return new DOMParser().parseFromString(s,"text/html")}function S(s){return s.textContent.trim()===""&&!s.firstElementChild}function m(s){return new URL(s.toString(),document.baseURI)}function x(s){return m(s).origin!==location.origin}function M(s){let t;return s.hash?s.hash.slice(1):(t=s.href.match(/#(.*)$/))?t[1]:null}function R(s){return M(m(s))!==null}function g(s){let t=0;for(let e=0;e<s.length;e++){let i=s.charCodeAt(e);t=(t<<5)-t+i,t&=t}return new Uint32Array([t])[0].toString(36)}function c(s){o.debug&&console.log(`[sco-pe] ${s}`)}window.addEventListener("popstate",s=>{if(!s.state)return;let t=s.state.id||null;if(!t)return;let e=document.querySelector(`sco-pe[id="${t}"]`);!e||(c("Restore location from history"),e.loadURL(document.location.toString()))});var A=class extends HTMLElement{constructor(){super();this.abortController=null,this.init=!1,this.events=["click","submit"],this.loadFunc=w(t=>{this.load(t)},o.debounceTime)}static configure(t){o=Object.assign(o,t)}handleEvent(t){if(t.target.closest("sco-pe")!==this||H(this.dataset.scopeDisabled))return;let e=t.target.closest("a,button,[data-scope-action]");if(t.type==="submit"&&(e=t.target),e){if(!y(e).includes(t.type))return;let n=L(e);if(!n||x(n)||R(n))return;c(`Handling ${t.type} on ${e.nodeName}`),t.preventDefault();let r=()=>{t.type==="click"?this.load(e):this.loadFunc(e)};e.dataset.scopeConfirm?o.confirmHandler(e.dataset.scopeConfirm).then(r).catch(d=>null):r()}}abortLoading(){this.abortController&&this.abortController.abort()}async load(t){let e=L(t),i=new URL(e,window.location.href).href,n=i,r=t.nodeName==="A",d=(t.getAttribute("method")||t.dataset.scopeMethod||"GET").toUpperCase(),l=r&&v(t,this)&&this.hasAttribute("id"),a,u=new URLSearchParams(window.location.search),b=t.value!=="undefined"?t.value:t.dataset.scopeValue;typeof b<"u"&&(u.set("value",b),n=`${i}?${u.toString()}`,a=u),t instanceof HTMLFormElement&&(a=new FormData(t));let h=t.dataset.scopeTarget||this.dataset.scopeTarget;if(h&&h!=="_self"){c(`Loading partial document into scope ${h}`),document.getElementById(h).setAttribute("src",n);return}if(l){let T={id:this.getAttribute("id"),url:i};history.pushState(T,null,i)}r&&(this.querySelectorAll(`.${o.activeClass}`).forEach(p=>{p.classList.remove(o.activeClass)}),t.classList.add(o.activeClass)),d==="GET"&&(i=n);let E=d==="POST"?a:null;await this.loadURL(i,{method:d,body:E})}async loadURL(t,e={}){e.signal||(f&&f.abort(),f=new AbortController,e.signal=f.signal);let i=Object.assign({method:"GET"},e),n=await fetch(t,i);if(!n.ok){let d=n.headers.get(o.statusHeader)||n.statusText;o.statusHandler(d,n.status);return}this.processHeaders(n);let r=await n.text();this.processResponse(r)}processHeaders(t){if(o.statusHeader){let e=t.headers.get(o.statusHeader);e&&o.statusHandler(e,t.status)}if(o.titleHeader){let e=t.headers.get(o.titleHeader);e&&(document.title=e)}if(o.reloadHeader&&t.headers.get(o.reloadHeader)&&window.location.reload(),o.jsHeader){let e=t.headers.get(o.jsHeader);e&&e.split(",").forEach(i=>{this._loadScript(i)})}if(o.cssHeader){let e=t.headers.get(o.cssHeader);e&&e.split(",").forEach(i=>{this._loadStyle(i)})}}processHead(t){c("Process head");let e=t.querySelector("title");e&&(document.title=e.textContent)}_loadScript(t,e=null){if(e||(e="text/javascript"),document.querySelector(`script[src="${t}"]`))return;c(`Loading script ${t}`);let n=document.createElement("script");n.setAttribute("type",e),n.setAttribute("src",t),document.head.appendChild(n)}_loadStyle(t){if(document.querySelector(`link[href="${t}"]`))return;c(`Loading style ${t}`);let i=document.createElement("link");i.setAttribute("rel","stylesheet"),i.setAttribute("href",t),document.head.appendChild(i)}processScriptsAndStyles(t){document.querySelectorAll("script:not([src]):not([id]),style:not([id])").forEach(e=>{let i=g(e.innerHTML),n=`${e.nodeName.toLowerCase()}-${i}`;e.setAttribute("id",n)}),t.querySelectorAll("script").forEach(e=>{let i=e.getAttribute("src"),n=e.type||"text/javascript";if(i)this._loadScript(i,n);else{let r=g(e.innerHTML),d=e.getAttribute("id")||`script-${r}`,l=document.querySelector(`script[id="${d}"]`);if(l&&e.getAttribute("id"))return;c("Loading inline script");let a=document.createElement("script");a.setAttribute("type",n),a.setAttribute("id",d),a.innerHTML=e.innerHTML,l?l.replaceWith(a):document.head.appendChild(a)}}),t.querySelectorAll('style,link[rel="stylesheet"]').forEach(e=>{let i=e.getAttribute("href");if(i)this._loadStyle(i);else{let n=g(e.innerHTML),r=e.getAttribute("id")||`style-${n}`;if(document.querySelector(`style[id="${r}"]`))return;c("Loading inline style");let l=document.createElement("style");l.innerHTML=e.innerHTML,l.setAttribute("id",r),document.head.appendChild(l)}})}processResponse(t){let e=t.match(/<!doctype\s+html[\s>]/i),i=t.indexOf("<sco-pe")!==-1;if(e||i){c(`Loading scopes ${e?"(full)":"(partial)"}`);let n=$(t),r=n.querySelector("head");r&&this.processHead(r),this.processScriptsAndStyles(n),n.querySelectorAll("sco-pe").forEach(l=>{let a=l.getAttribute("id");if(!a){c("Scope without id");return}if(S(l)){c(`Empty scope for ${a}`);return}let u=document.getElementById(a);if(!u){c(`No matching scope for ${a}`);return}c(`Replacing ${a}`),u.outerHTML=l.outerHTML})}else c("Loading partial document into self"),this.innerHTML=t,this.afterLoad()}async loadContent(t=!1){let e=this.src,i=t&&!S(this);e&&!i&&(this.abortLoading(),this.abortController=new AbortController,await this.loadURL(e,{signal:this.abortController.signal})),this.afterLoad()}afterLoad(){this.listenToEvents(),this.querySelectorAll("a").forEach(t=>{m(t.getAttribute("href")).toString()==document.location.href&&t.classList.add(o.activeClass)}),o.onLoad(this),this.classList.remove("scope-loading"),this.classList.add("scope-loaded")}listenToEvents(){this.querySelectorAll("[data-scope-on]").forEach(t=>{this.events=this.events.concat(y(t))}),this.events.forEach(t=>{this.addEventListener(t,this)})}async fetchSelf(t,e={}){this.abortLoading(),this.abortController=new AbortController;let i=Object.assign({signal:this.abortController.signal},e);return await(await fetch(t,i)).text()}static get observedAttributes(){return["src"]}set src(t){this.setAttribute("src",t)}get src(){return this.getAttribute("src")}attributeChangedCallback(t,e,i){if(!!this.init)switch(t){case"src":this.loadContent();break}}connectedCallback(){this.classList.add("scope-loading"),setTimeout(()=>{this.loadContent(!0),this.init=!0,c(`Scope created ${this.id}`)})}disconnectedCallback(){this.events.forEach(t=>{this.removeEventListener(t,this)})}},C=A;customElements.define("sco-pe",C);
//# sourceMappingURL=sco-pe.min.js.map
