var r={debug:!1,debounceTime:300,activeClass:"active",reloadHeader:"X-Reload",titleHeader:"X-Title",cssHeader:"x-include-css",jsHeader:"x-include-js",confirmHandler:n=>new Promise((t,e)=>{confirm(n)?t():e()}),statusHeader:"X-Status",statusHandler:(n,t)=>{alert(n)},onLoad:()=>{},onScopeLoad:n=>{}},g=null,m=[],y=!0,b=[],S=!1,L;function E(n){return n instanceof HTMLFormElement?["submit"]:(n.dataset.scopeOn||"click").split(",")}function H(n){return n.getAttribute("action")||n.dataset.scopeAction||n.getAttribute("href")}function q(n,t=300){let e;return(...s)=>{clearTimeout(e),e=setTimeout(()=>{n.apply(this,s)},t)}}function _(n){return["1","true",!0,1].includes(n)}function I(n,t=null){let e="true";return n.dataset.scopeHistory?e=n.dataset.scopeHistory:t&&t.dataset.scopeHistory&&(e=t.dataset.scopeHistory),_(e)}function R(n){return new DOMParser().parseFromString(n,"text/html")}function U(n){let t=document.createElement("template");return t.innerHTML=n,t.content}function j(n){let t=document.createElement("div");return t.appendChild(n),t.innerHTML}function T(n){return n.textContent.trim()===""&&!n.firstElementChild}function p(n){let t=n?n.toString():"#";return new URL(t,document.baseURI)}function D(n){return n?p(n).origin!==location.origin:!1}function P(n){return n.getAttribute("target")==="_blank"}function F(n){if(!n)return null;let t;return n.hash?n.hash.slice(1):(t=n.href.match(/#(.*)$/))?t[1]:null}function C(n){return F(p(n))!==null}function A(n){let t=0;for(let e=0;e<n.length;e++){let s=n.charCodeAt(e);t=(t<<5)-t+s,t&=t}return new Uint32Array([t])[0].toString(36)}function v(n){return n===null?null:n.scrollHeight>n.clientHeight?n:v(n.parentElement)}function B(n){let t=v(n);t?t.scrollTop=0:n.scrollIntoView(!0)}function o(n){r.debug&&console.log(`[sco-pe] ${n}`)}window.addEventListener("popstate",n=>{if(!n.state)return;let t=n.state.id||null;if(!t)return;let e=document.querySelector(`sco-pe[id="${t}"]`);if(!e){window.location.replace(document.location.toString());return}o("Restore location from history"),e.loadURL(document.location.toString())});var $=class extends HTMLElement{constructor(){super();this.abortController=null,this.init=!1,this.events=["click","submit"],this.loadFunc=q(t=>{this.load(t)},r.debounceTime)}static configure(t){r=Object.assign(r,t)}handleEvent(t){if(t.target.closest("sco-pe")!==this||_(this.dataset.scopeDisabled))return;let e=t.target.closest("a,button,[data-scope-action]");if(t.type==="submit"&&(e=t.target),e){if(!E(e).includes(t.type))return;let i=H(e);if(!i||P(e)||D(i)||C(i))return;o(`Handling ${t.type} on ${e.nodeName}`),t.preventDefault();let c=()=>{t.type==="click"?this.load(e):this.loadFunc(e)};e.dataset.scopeConfirm?r.confirmHandler(e.dataset.scopeConfirm).then(c).catch(a=>null):c()}}abortLoading(){this.abortController&&this.abortController.abort()}async load(t){let e=H(t),s=p(e).href,i=s,c=t.nodeName==="A",a=(t.getAttribute("method")||t.dataset.scopeMethod||"GET").toUpperCase(),f=c&&I(t,this)&&this.hasAttribute("id"),l,d=new URLSearchParams(window.location.search),h=t.value!=="undefined"?t.value:t.dataset.scopeValue;typeof h<"u"&&(d.set("value",h),i=`${s}?${d.toString()}`,l=d),t instanceof HTMLFormElement&&(l=new FormData(t));let u=t.dataset.scopeTarget||this.dataset.scopeTarget;if(u&&u!=="_self"){o(`Loading partial document into scope ${u}`),document.getElementById(u).setAttribute("src",i);return}if(f){let k={id:this.getAttribute("id"),url:s};history.pushState(k,null,s)}c&&this.setActive(t),a==="GET"&&(s=i);let x=a==="POST"?l:null;await this.loadURL(s,{method:a,body:x})}setActive(t){o("Set active element"),this.querySelectorAll(`.${r.activeClass}`).forEach(e=>{e.classList.remove(r.activeClass)}),t.classList.add(r.activeClass)}async loadURL(t,e={}){e.signal||(o(`GET ${t}`),g&&g.abort(),g=new AbortController,e.signal=g.signal);let s=Object.assign({method:"GET"},e);try{let i=await fetch(t,s);if(!i.ok){let a=i.headers.get(r.statusHeader)||i.statusText;r.statusHandler(a,i.status);return}this._processHeaders(i);let c=await i.text();this._processResponse(c)}catch(i){r.statusHandler(i.message)}}_processHeaders(t){if(r.statusHeader){let e=t.headers.get(r.statusHeader);e&&r.statusHandler(e,t.status)}if(r.titleHeader){let e=t.headers.get(r.titleHeader);e&&(document.title=e)}if(r.reloadHeader&&t.headers.get(r.reloadHeader)&&window.location.reload(),r.jsHeader){let e=t.headers.get(r.jsHeader);e&&e.split(",").forEach(s=>{this._loadScript(s)})}if(r.cssHeader){let e=t.headers.get(r.cssHeader);e&&e.split(",").forEach(s=>{this._loadStyle(s)})}}_processHead(t){o("Process head");let e=t.querySelector("title");e&&(document.title=e.textContent)}_processBody(t){document.body.style.cssText=t.style.cssText,["class"].forEach(s=>{document.body.setAttribute(s,t.getAttribute(s)||"")})}_processDocument(t){["class"].forEach(s=>{document.documentElement.setAttribute(s,t.documentElement.getAttribute(s)||"")});for(let s in t.documentElement.dataset)document.documentElement.dataset[s]=t.documentElement.dataset[s]}_loadScript(t,e="text/javascript"){return document.querySelector(`script[src="${t}"]`)?!1:(o(`Loading script ${t}`),b.push({type:e,src:t}),!0)}_processScriptsQueue(){y=b.length===0;let t=b.shift();if(y){S&&this._processInlineScriptsQueue(),o("All scripts loaded");return}let e=document.createElement("script");e.setAttribute("type",t.type),e.setAttribute("src",t.src),e.onload=e.onerror=s=>{o(`Loaded script ${t.src}`),this._processScriptsQueue()},document.head.appendChild(e)}_loadInlineScript(t){let e=A(t.innerHTML),s=t.type||"text/javascript",i=t.getAttribute("id")||`script-${e}`;if(document.querySelector(`script[id="${i}"]`)&&t.getAttribute("id"))return;let a=t.innerHTML;m.push({content:a,type:s,id:i})}_processInlineScriptsQueue(){o(`Executing ${m.length} inline scripts`),m.forEach(t=>{o("Executing inline script");let e=document.createElement("script");e.setAttribute("type",t.type),e.setAttribute("id",t.id),e.innerHTML=t.content;let s=document.querySelector(`script[id="${t.id}"]`);s?s.replaceWith(e):document.head.appendChild(e)}),m=[],o("Calling global onload"),r.onLoad()}_loadStyle(t){if(document.querySelector(`link[href="${t}"]`))return;o(`Loading style ${t}`);let s=document.createElement("link");s.setAttribute("rel","stylesheet"),s.setAttribute("href",t),document.head.appendChild(s)}_processScriptsAndStyles(t){document.querySelectorAll("script:not([src]):not([id]),style:not([id])").forEach(s=>{let i=A(s.innerHTML),c=`${s.nodeName.toLowerCase()}-${i}`;s.setAttribute("id",c)});let e=!0;t.querySelectorAll("script").forEach(s=>{s.hasAttribute("src")?this._loadScript(s.getAttribute("src"),s.type)&&(e=!1):this._loadInlineScript(s),s.remove()}),e||this._processScriptsQueue(),o(`There are ${m.length} pending inline scripts (${e})`),t.querySelectorAll('style,link[rel="stylesheet"]').forEach(s=>{let i=s.getAttribute("href");if(i)this._loadStyle(i);else{let c=A(s.innerHTML),a=s.getAttribute("id")||`style-${c}`;if(document.querySelector(`style[id="${a}"]`))return;o("Loading inline style");let l=document.createElement("style");l.innerHTML=s.innerHTML,l.setAttribute("id",a),document.head.appendChild(l)}})}_processResponse(t){let e=t.match(/<!doctype\s+html[\s>]/i),s=t.indexOf("<sco-pe")!==-1,i=e?R(t):U(t);if(this._processScriptsAndStyles(i),e||s){o(`Loading scopes ${e?"(full)":"(partial)"}`);let c=i.querySelector("head");c&&this._processHead(c);let a=i.querySelector("body");a&&this._processBody(a),e&&this._processDocument(i);let f=i.querySelectorAll("sco-pe");f.length||(document.body.innerHTML=t,this._checkScopesAreLoaded()),f.forEach(l=>{let d=l.getAttribute("id");if(!d){o("Scope without id");return}let h=l.getAttribute("src");if(T(l)&&!h){o(`Empty scope for ${d}`);return}let u=document.getElementById(d);if(!u){o(`No matching scope for ${d}`);return}if(h&&p(h).toString()===p(u.src).toString()){o(`Url has not changed for ${d}`);return}o(`Replacing ${d} content`),h?u.src=h:(u.innerHTML=l.innerHTML,this._afterLoad())}),document.scrollingElement.scrollTo(0,0)}else o(`Loading partial document into self ${this.id}`),this.innerHTML=j(i),this._afterLoad(),B(this)}async loadContent(t=!1){let e=this.src,s=t&&!T(this);e&&!s?(this.classList.add("scope-loading"),this.classList.remove("scope-loaded"),this.abortLoading(),this.abortController=new AbortController,await this.loadURL(e,{signal:this.abortController.signal})):this._afterLoad()}_afterLoad(){this._listenToEvents(),this.querySelectorAll("a").forEach(t=>{let e=t.getAttribute("href"),s=p(e);C(s)||s.toString()==document.location.href&&this.setActive(t)}),this.classList.remove("scope-loading"),this.classList.add("scope-loaded"),this.dispatchEvent(new CustomEvent("scope-loaded")),r.onScopeLoad(this),this._checkScopesAreLoaded()}_checkScopesAreLoaded(){L&&clearTimeout(L),L=setTimeout(()=>{S=document.querySelectorAll("sco-pe:not(.scope-loaded)").length===0,S&&y&&(this._processInlineScriptsQueue(),o("All scripts loaded (no scripts to load)"))})}_listenToEvents(){this.querySelectorAll("[data-scope-on]").forEach(t=>{this.events=this.events.concat(E(t))}),this.events.forEach(t=>{this.addEventListener(t,this)})}async fetchSelf(t,e={}){this.abortLoading(),this.abortController=new AbortController;let s=Object.assign({signal:this.abortController.signal},e);return await(await fetch(t,s)).text()}static get observedAttributes(){return["src"]}set src(t){this.setAttribute("src",t)}get src(){return this.getAttribute("src")}attributeChangedCallback(t,e,s){if(!!this.init)switch(t){case"src":this.loadContent();break}}connectedCallback(){setTimeout(async()=>{await this.loadContent(!0),this.init=!0,o(`Scope created ${this.id||"(no id)"}`)})}disconnectedCallback(){this.events.forEach(t=>{this.removeEventListener(t,this)}),o(`Scope destroyed ${this.id||"(no id)"}`)}},w=$;customElements.define("sco-pe",w);
//# sourceMappingURL=sco-pe.min.js.map
