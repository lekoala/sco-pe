var c={debug:!1,loadDelay:300,activeClass:"active",reloadHeader:"X-Reload",titleHeader:"X-Title",cssHeader:"x-include-css",jsHeader:"x-include-js",confirmHandler:n=>new Promise((t,e)=>{confirm(n)?t():e()}),statusHeader:"X-Status",statusHandler:(n,t)=>{alert(n)},onLoad:n=>{},onScopeLoad:n=>{}},y=null,m=[],S=!0,L=[],A=!1,H;function C(n){return n instanceof HTMLFormElement?["submit"]:(n.dataset.scopeOn||"click").split(",")}function $(n){return n.getAttribute("action")||n.dataset.scopeAction||n.getAttribute("href")}function R(n,t=300){let e;return(...s)=>{e&&clearTimeout(e),e=setTimeout(()=>{n.apply(this,s)},t)}}function x(n){return["1","true",!0,1].includes(n)}function D(n,t=null){let e="true";return n.dataset.scopeHistory?e=n.dataset.scopeHistory:t&&t.dataset.scopeHistory&&(e=t.dataset.scopeHistory),x(e)}function U(n){return new DOMParser().parseFromString(n,"text/html")}function F(n){let t=document.createElement("template");return t.innerHTML=n,t.content}function j(n){let t=document.createElement("div");return t.appendChild(n),t.innerHTML}function _(n){return n.textContent.trim()===""&&!n.firstElementChild}function f(n){let t=n?n.toString():"#";return new URL(t,document.baseURI)}function P(n){return n?f(n).origin!==location.origin:!1}function B(n){return n.getAttribute("target")==="_blank"}function N(n){if(!n)return null;let t;return n.hash?n.hash.slice(1):(t=n.href.match(/#(.*)$/))?t[1]:null}function w(n){return N(f(n))!==null}function E(n){let t=0;for(let e=0;e<n.length;e++){let s=n.charCodeAt(e);t=(t<<5)-t+s,t&=t}return new Uint32Array([t])[0].toString(36)}function M(n){return n===null?null:n.scrollHeight>n.clientHeight?n:M(n.parentElement)}function Q(n){let t=M(n);t?t.scrollTop=0:n.scrollIntoView(!0)}function r(n){c.debug&&console.log(`[sco-pe] ${n}`)}function V(n,t){let e=new RegExp(`<[a-z]+-[a-z]+.*>.*</[a-z]+-[a-z]+>|${c.activeClass}|\\s+|style=".*?"`,"gmi"),s=n.innerHTML.replace(e,"").trim(),i=t.innerHTML.replace(e,"").trim();return s!=i}function z(n,t){let e=n.querySelectorAll("[data-scope-fragment]");if(!e.length){r(`Replacing ${n.id} content`),n.innerHTML=t.innerHTML;return}e.forEach(s=>{let i=s.id?`#${s.id}`:`.${s.classList.item(0)}`,a=t.querySelector(i);if(a){let o=s.dataset.scopeFragment;(o.length>0?o!=a.dataset.scopeFragment:!s.isEqualNode(a))&&(r(`Replacing ${i} fragment`),s.innerHTML=a.innerHTML)}else s.dataset.scopedFixed||s.remove()})}window.addEventListener("popstate",async n=>{if(n.state){let t=n.state.id||null;if(t){let e=document.querySelector(`sco-pe[id="${t}"]`);if(e){r("Restore location from history"),await e.loadURL(document.location.toString(),{},n.state.hint);return}}}window.location.replace(document.location.toString())});var q=class extends HTMLElement{constructor(){super();this.abortController=null,this.init=!1,this.events=["click","submit"],this.loadFunc=R((t,e)=>{this.load(t,e)},c.loadDelay)}static configure(t){c=Object.assign(c,t)}handleEvent(t){if(t.target.closest("sco-pe")!==this||x(this.dataset.scopeDisabled))return;let e=t.target.closest("a,button,[data-scope-action]");if(t.type==="submit"&&(e=t.target),e){if(!C(e).includes(t.type))return;let i=$(e);if(!i||B(e)||P(i)||w(i))return;r(`Handling ${t.type} on ${e.nodeName}`),t.preventDefault();let a=["input","scroll","resize","mousemove","touchmove","keyup","keydown"],o=()=>{a.includes(t.type)?this.loadFunc(e,t):this.load(e,t)};e.dataset.scopeConfirm?c.confirmHandler(e.dataset.scopeConfirm).then(o).catch(l=>null):o()}}abortLoading(){this.abortController&&this.abortController.abort()}async load(t,e){let s=$(t),i=f(s).href,a=i,o=t.nodeName==="A",l=e.submitter||null,d=t.dataset.scopeHint,u=(t.getAttribute("method")||t.dataset.scopeMethod||"GET").toUpperCase(),p=o&&D(t,this)&&this.hasAttribute("id"),h;l&&l.setAttribute("disabled","");let b=new URLSearchParams(window.location.search),T=t.value!=="undefined"?t.value:t.dataset.scopeValue;if(typeof T<"u"&&(b.set("value",T),a=`${i}?${b.toString()}`,h=b),t instanceof HTMLFormElement){let v=new FormData(t);l&&v.append(l.name,l.value||"true"),h=v}let g=t.dataset.scopeTarget||this.dataset.scopeTarget;if(g&&g!=="_self"){r(`Loading into targeted scope ${g}`),document.getElementById(g).setAttribute("src",a);return}p&&this.updateHistory(i,d),o&&this.setActive(t),u==="GET"&&(i=a);let I=u==="POST"?h:null;await this.loadURL(i,{method:u,body:I},d),l&&l.removeAttribute("disabled")}updateHistory(t,e){let i={id:this.getAttribute("id"),url:t,hint:e};history.pushState(i,null,t)}setActive(t){r("Set active element"),this.querySelectorAll(`.${c.activeClass}`).forEach(e=>{e===document.activeElement&&e.blur(),e.classList.remove(c.activeClass)}),t.classList.add(c.activeClass)}async loadURL(t,e={},s=null){e.signal||(r(`GET ${t}`),y&&y.abort(),y=new AbortController,e.signal=y.signal);let i=Object.assign({method:"GET"},e),a=s?document.getElementById(s):this;a.classList.add("scope-fetching");try{let o=await fetch(t,i);if(o.redirected&&this.updateHistory(o.url,s),!o.ok){let d=o.headers.get(c.statusHeader)||o.statusText;c.statusHandler(d,o.status);return}this._processHeaders(o);let l=await o.text();this._processResponse(l)}catch(o){o.name==="AbortError"||c.statusHandler(o.message)}a.classList.remove("scope-fetching")}_processHeaders(t){if(c.statusHeader){let e=t.headers.get(c.statusHeader);e&&c.statusHandler(e,t.status)}if(c.titleHeader){let e=t.headers.get(c.titleHeader);e&&(document.title=e)}if(c.reloadHeader&&t.headers.get(c.reloadHeader)&&window.location.reload(),c.jsHeader){let e=t.headers.get(c.jsHeader);e&&e.split(",").forEach(s=>{this._loadScript(s)})}if(c.cssHeader){let e=t.headers.get(c.cssHeader);e&&e.split(",").forEach(s=>{this._loadStyle(s)})}}_processHead(t){r("Process head");let e=t.querySelector("title");e&&(document.title=e.textContent)}_processBody(t){document.body.style.cssText=t.style.cssText,["class"].forEach(s=>{document.body.setAttribute(s,t.getAttribute(s)||"")})}_processDocument(t){["class"].forEach(s=>{document.documentElement.setAttribute(s,t.documentElement.getAttribute(s)||"")});for(let s in t.documentElement.dataset)document.documentElement.dataset[s]=t.documentElement.dataset[s]}_loadScript(t,e="text/javascript"){return document.querySelector(`script[src="${t}"]`)?!1:(r(`Loading script ${t}`),L.push({type:e,src:t}),!0)}_processScriptsQueue(){S=L.length===0;let t=L.shift();if(S){A&&this._processInlineScriptsQueue(),r("All scripts loaded");return}let e=document.createElement("script");e.setAttribute("type",t.type),e.setAttribute("src",t.src),e.onload=e.onerror=s=>{r(`Loaded script ${t.src}`),this._processScriptsQueue()},document.head.appendChild(e)}_loadInlineScript(t){let e=E(t.innerHTML),s=t.type||"text/javascript",i=t.getAttribute("id")||`script-${e}`;if(document.querySelector(`script[id="${i}"]`)&&t.getAttribute("id"))return;let o=t.innerHTML;m.push({content:o,type:s,id:i})}_processInlineScriptsQueue(){r(`Executing ${m.length} inline scripts`),m.forEach(t=>{r("Executing inline script");let e=document.createElement("script");e.setAttribute("type",t.type),e.setAttribute("id",t.id),e.innerHTML=t.content;let s=document.querySelector(`script[id="${t.id}"]`);s?s.replaceWith(e):document.head.appendChild(e)}),m=[],r("Calling global onload"),c.onLoad(this)}_loadStyle(t){if(document.querySelector(`link[href="${t}"]`))return;r(`Loading style ${t}`);let s=document.createElement("link");s.setAttribute("rel","stylesheet"),s.setAttribute("href",t),document.head.appendChild(s)}_processScriptsAndStyles(t){document.querySelectorAll("script:not([src]):not([id]),style:not([id])").forEach(s=>{let i=E(s.innerHTML),a=`${s.nodeName.toLowerCase()}-${i}`;s.setAttribute("id",a)});let e=!0;t.querySelectorAll("script").forEach(s=>{s.hasAttribute("src")?this._loadScript(s.getAttribute("src"),s.type)&&(e=!1):this._loadInlineScript(s),s.remove()}),e||this._processScriptsQueue(),r(`${m.length} pending inline scripts ${e?"(can trigger immediately)":""}`),t.querySelectorAll('style,link[rel="stylesheet"]').forEach(s=>{let i=s.getAttribute("href");if(i)this._loadStyle(i);else{let a=E(s.innerHTML),o=s.getAttribute("id")||`style-${a}`;if(document.querySelector(`style[id="${o}"]`))return;r("Loading inline style");let d=document.createElement("style");d.innerHTML=s.innerHTML,d.setAttribute("id",o),document.head.appendChild(d)}})}_processResponse(t){let e=t.match(/<!doctype\s+html[\s>]/i),s=t.indexOf("<sco-pe")!==-1,i=e?U(t):F(t);if(this._processScriptsAndStyles(i),e||s){r(`Loading scopes ${e?"(full)":"(partial)"}`);let a=i.querySelector("head");a&&this._processHead(a);let o=i.querySelector("body");o&&this._processBody(o),e&&i instanceof Document&&this._processDocument(i);let l=i.querySelectorAll("sco-pe");l.length||(document.body.innerHTML=t,this._checkScopesAreLoaded()),l.forEach(d=>{let u=d.getAttribute("id");if(!u){r("Scope without id");return}let p=d.getAttribute("src");if(_(d)&&!p){r(`Empty scope for ${u}`);return}let h=document.getElementById(u);if(!h){r(`No matching scope for ${u}`);return}if(p&&f(p).toString()===f(h.src).toString()){r(`Url has not changed for ${u}`);return}p&&p!=h.src?(r(`Replacing ${u} src`),h.src=p):V(h,d)&&(z(h,d),this._afterLoad())}),document.scrollingElement.scrollTo(0,0)}else r(`Loading partial document into self (${this.id})`),this.innerHTML=j(i),this._afterLoad(),Q(this)}async loadContent(t=!1){let e=this.src,s=t&&!_(this);e&&!s?(this.classList.remove("scope-loaded"),this.abortLoading(),this.abortController=new AbortController,await this.loadURL(e,{signal:this.abortController.signal})):this._afterLoad()}_afterLoad(){this._listenToEvents(),this.querySelectorAll("a").forEach(t=>{let e=t.getAttribute("href"),s=f(e);w(s)||s.toString()==document.location.href&&this.setActive(t)}),this.classList.remove("scope-fetching"),this.classList.add("scope-loaded"),this.dispatchEvent(new CustomEvent("scope-loaded")),c.onScopeLoad(this),this._checkScopesAreLoaded()}_checkScopesAreLoaded(){H&&clearTimeout(H),H=setTimeout(()=>{A=document.querySelectorAll("sco-pe:not(.scope-loaded)").length===0,A&&S&&(this._processInlineScriptsQueue(),r("All scripts loaded (no scripts to load)"))})}_listenToEvents(){this.querySelectorAll("[data-scope-on]").forEach(t=>{this.events=this.events.concat(C(t))}),this.events.forEach(t=>{this.addEventListener(t,this)})}static get observedAttributes(){return["src"]}set src(t){this.setAttribute("src",t)}get src(){return this.getAttribute("src")}attributeChangedCallback(t,e,s){if(!!this.init)switch(t){case"src":this.loadContent();break}}connectedCallback(){setTimeout(async()=>{r(`Scope init ${this.id||"(no id)"}`),await this.loadContent(!0),this.init=!0,r(`Scope created ${this.id||"(no id)"}`)})}disconnectedCallback(){this.events.forEach(t=>{this.removeEventListener(t,this)}),r(`Scope destroyed ${this.id||"(no id)"}`)}},k=q;customElements.define("sco-pe",k);
//# sourceMappingURL=sco-pe.min.js.map
